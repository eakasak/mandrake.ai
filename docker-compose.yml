version: '2'
services:

  mandrake-db:
    user: root
    image: mongo:latest
    restart: always
    command: ["mongod", "--smallfiles"]
    container_name: mandrake-db
    ports:
      - "27017:27017"
    volumes:
      - ./data/db:/data/db:rw

  mandrake-nlp:
    user: root
    build: ./nlp/.
    restart: always
    container_name: mandrake-nlp
    ports:
      - "5000:5000"
    volumes:
      - ./config/nlp/config.json:/app/config_mitie.json:rw
      - ./config/nlp/train.json:/app/data/examples/rasa/demo-rasa.json:ro
      - ./data/models:/app/models
    environment:
      - SERVICE_NAME=mandrake-nlp
    command: python -m rasa_nlu.server -c config_mitie.json --server_model_dirs="${RASA_MODEL}"

  mandrake-flow:
    user: root
    build: ./flow/.
    restart: always
    ports:
      - "9000:9000"
    container_name: mandrake-flow
    environment:
      - SERVICE_NAME=mandrake-flow
    volumes:
       - "./data:/home/mandrake-ai/data"
    depends_on:
      - mandrake-nlp
      - mandrake-mq
    links:
      - mandrake-nlp
      - mandrake-mq
    environment:
      - SERVICE_NAME=mandrake-flow
    command: ["npm", "start"]

  mandrake-connector:
    user: root
    build: ./connector/.
    restart: always
    container_name: mandrake-connector
    depends_on:
      - mandrake-db
    links:
      - mandrake-db
    environment:
      - SERVICE_NAME=mandrake-connector
      - NODE_ENV=developemnt
    ports:
      - "6060:6060"
    command: ["yarn", "start"]

  mandrake-mq:
    user: root
    restart: always
    image: "eclipse-mosquitto:1.4.8"
    container_name: mandrake-mq
    environment:
      - SERVICE_NAME=mandrake-mq
    ports:
      - "1883:1883"
      - "9001:9001"
      - "9883:9883"
